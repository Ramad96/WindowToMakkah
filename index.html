<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Qibla Finder v1.8.0 - Window to Makkah</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            overflow: hidden;
            background: #000;
            color: #fff;
        }

        #container {
            position: relative;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }

        #video {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            min-width: 100%;
            min-height: 100%;
            width: auto;
            height: auto;
            object-fit: cover;
        }

        #compassFallback {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        #compassFallback.active {
            display: flex;
        }

        .compass-circle {
            width: 280px;
            height: 280px;
            border-radius: 50%;
            border: 4px solid rgba(255, 255, 255, 0.3);
            position: relative;
            background: rgba(0, 0, 0, 0.3);
            margin-bottom: 30px;
        }

        .compass-needle {
            position: absolute;
            top: 50%;
            left: 50%;
            transform-origin: center;
            width: 4px;
            height: 120px;
            background: #ff4444;
            transform: translate(-50%, -100%);
            border-radius: 2px;
            box-shadow: 0 0 10px rgba(255, 68, 68, 0.5);
        }

        .compass-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 20px;
            background: #fff;
            border-radius: 50%;
            border: 3px solid #ff4444;
        }

        .compass-marker {
            position: absolute;
            font-size: 18px;
            font-weight: bold;
            color: rgba(255, 255, 255, 0.8);
        }

        .compass-marker.n { top: 10px; left: 50%; transform: translateX(-50%); }
        .compass-marker.e { right: 10px; top: 50%; transform: translateY(-50%); }
        .compass-marker.s { bottom: 10px; left: 50%; transform: translateX(-50%); }
        .compass-marker.w { left: 10px; top: 50%; transform: translateY(-50%); }

        #overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10;
            perspective: 2000px;
            perspective-origin: center center;
            transform-style: preserve-3d;
        }

        #qiblaDome {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 80vw;
            max-width: 800px;
            height: 60vh;
            max-height: 600px;
            z-index: 20;
            transition: transform 0.1s linear;
            opacity: 1;
            visibility: visible;
            cursor: pointer;
            touch-action: manipulation;
            transform-style: preserve-3d;
            will-change: transform;
        }

        .window-frame {
            width: 100%;
            height: 100%;
            position: relative;
            background: #8B4513;
            border: 20px solid #654321;
            border-radius: 8px;
            box-shadow: 
                0 0 60px rgba(0, 0, 0, 0.6),
                inset 0 0 40px rgba(0, 0, 0, 0.3),
                0 30px 80px rgba(0, 0, 0, 0.5);
            overflow: hidden;
            background-image: 
                linear-gradient(90deg, rgba(0, 0, 0, 0.1) 0%, transparent 2px, transparent calc(100% - 2px), rgba(0, 0, 0, 0.1) 100%),
                linear-gradient(0deg, rgba(0, 0, 0, 0.1) 0%, transparent 2px, transparent calc(100% - 2px), rgba(0, 0, 0, 0.1) 100%);
            background-size: 40px 40px;
        }

        .window-panes {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            bottom: 20px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 8px;
            z-index: 1;
        }

        .window-pane {
            background: rgba(200, 220, 255, 0.1);
            border: 3px solid rgba(139, 69, 19, 0.5);
            backdrop-filter: blur(2px);
        }

        .window-shutters {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            bottom: 20px;
            z-index: 3;
            pointer-events: none;
        }

        .window-shutter-left,
        .window-shutter-right {
            position: absolute;
            top: 0;
            width: 50%;
            height: 100%;
            background: #8B4513;
            border: 4px solid #654321;
            box-shadow: 
                0 0 20px rgba(0, 0, 0, 0.5),
                inset 0 0 30px rgba(0, 0, 0, 0.3);
            transition: transform 1.2s cubic-bezier(0.4, 0, 0.2, 1);
            transform-origin: center;
            background-image: 
                repeating-linear-gradient(90deg, 
                    transparent 0px,
                    transparent 8px,
                    rgba(0, 0, 0, 0.1) 8px,
                    rgba(0, 0, 0, 0.1) 10px
                );
        }

        .window-shutter-left {
            left: 0;
            border-right: 6px solid #654321;
        }

        .window-shutter-right {
            right: 0;
            border-left: 6px solid #654321;
        }

        .window-shutter-left::before,
        .window-shutter-right::before {
            content: '';
            position: absolute;
            top: 50%;
            width: 40px;
            height: 40px;
            background: #654321;
            border-radius: 50%;
            transform: translateY(-50%);
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5);
        }

        .window-shutter-left::before {
            right: 20px;
        }

        .window-shutter-right::before {
            left: 20px;
        }

        #qiblaDome.opened .window-shutter-left {
            transform: translateX(-100%);
        }

        #qiblaDome.opened .window-shutter-right {
            transform: translateX(100%);
        }

        .makkah-image {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            bottom: 20px;
            background: linear-gradient(135deg, #1a472a 0%, #2d5a3d 50%, #1a472a 100%);
            background-image: url('https://images.unsplash.com/photo-1605540436563-5bca919ae766?w=1200&h=900&fit=crop&q=90');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.8s ease-out 0.5s, visibility 0s 1.5s;
            z-index: 2;
            box-shadow: inset 0 0 60px rgba(0, 0, 0, 0.2);
        }

        #qiblaDome.opened .makkah-image {
            opacity: 1;
            visibility: visible;
            transition: opacity 0.8s ease-out 0.5s, visibility 0s 0s;
        }

        #infoPanel {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            padding: 15px 25px;
            border-radius: 15px;
            text-align: center;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 30;
            min-width: 280px;
            max-width: 90%;
        }

        #degrees {
            font-size: 32px;
            font-weight: bold;
            color: #00ff88;
            margin-bottom: 5px;
        }

        #qiblaLabel {
            font-size: 16px;
            color: #fff;
            font-weight: 500;
            margin-bottom: 12px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
            font-size: 13px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .info-row:first-of-type {
            border-top: none;
            margin-top: 8px;
        }

        .info-label {
            color: rgba(255, 255, 255, 0.7);
            text-align: left;
            flex: 1;
        }

        .info-value {
            color: #fff;
            font-weight: 600;
            text-align: right;
            flex: 1;
        }

        #status {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            padding: 12px 20px;
            border-radius: 10px;
            font-size: 14px;
            color: #fff;
            text-align: center;
            max-width: 90%;
            z-index: 30;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        #instructions {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.85);
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            max-width: 90%;
            z-index: 100;
            backdrop-filter: blur(15px);
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        #instructions.hidden {
            display: none;
        }

        #instructions h2 {
            margin-bottom: 20px;
            color: #00ff88;
            font-size: 24px;
        }

        #instructions p {
            margin-bottom: 15px;
            line-height: 1.6;
            color: #fff;
        }

        #instructions button {
            background: #00ff88;
            color: #000;
            border: none;
            padding: 15px 40px;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        #instructions button:active {
            transform: scale(0.95);
        }

        #locationSearch {
            margin: 20px 0;
        }

        #locationInput {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 16px;
            margin-bottom: 10px;
        }

        #locationInput::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        #locationInput:focus {
            outline: none;
            border-color: #00ff88;
            background: rgba(255, 255, 255, 0.15);
        }

        #searchResults {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.5);
            display: none;
        }

        #searchResults.active {
            display: block;
        }

        .search-result-item {
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            transition: background 0.2s;
        }

        .search-result-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .search-result-name {
            font-weight: 600;
            color: #fff;
            margin-bottom: 4px;
        }

        .search-result-details {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
        }

        .location-option {
            margin: 15px 0;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .location-option-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #00ff88;
        }

        .location-option button {
            width: 100%;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 10px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .location-option button:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: #00ff88;
        }

        #error {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 68, 68, 0.9);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            max-width: 90%;
            z-index: 200;
            display: none;
        }

        #error.active {
            display: block;
        }

        #disclaimer {
            position: absolute;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.6);
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 11px;
            color: rgba(255, 255, 255, 0.7);
            text-align: center;
            max-width: 85%;
            z-index: 30;
            backdrop-filter: blur(5px);
        }

        .loading {
            color: #00ff88;
        }

        @media (max-width: 480px) {
            #infoPanel {
                top: 10px;
                padding: 12px 20px;
                min-width: 260px;
            }

            #degrees {
                font-size: 28px;
            }

            #qiblaLabel {
                font-size: 14px;
            }

            .info-row {
                font-size: 12px;
            }

            #instructions {
                padding: 25px 20px;
            }

            #instructions h2 {
                font-size: 20px;
            }

            .compass-circle {
                width: 240px;
                height: 240px;
            }

            #qiblaDome {
                width: 140%;
                max-width: 1000px;
                height: 110vh;
                max-height: 900px;
            }

            .window-frame {
                border-width: 15px;
            }

            .window-panes {
                top: 15px;
                left: 15px;
                right: 15px;
                bottom: 15px;
                gap: 6px;
            }

            .window-pane {
                border-width: 2px;
            }

            .window-shutters {
                top: 15px;
                left: 15px;
                right: 15px;
                bottom: 15px;
            }

            .makkah-image {
                top: 15px;
                left: 15px;
                right: 15px;
                bottom: 15px;
            }


            #locationInput {
                font-size: 14px;
                padding: 10px 12px;
            }

            .location-option {
                padding: 12px;
            }

            .location-option-title {
                font-size: 14px;
            }

            .search-result-item {
                padding: 10px 12px;
            }

            .search-result-name {
                font-size: 14px;
            }

            .search-result-details {
                font-size: 11px;
            }
        }
    </style>
</head>
<body>
    <div id="container">
        <video id="video" autoplay playsinline></video>
        
        <div id="compassFallback">
            <div class="compass-circle">
                <div class="compass-marker n">N</div>
                <div class="compass-marker e">E</div>
                <div class="compass-marker s">S</div>
                <div class="compass-marker w">W</div>
                <div class="compass-needle" id="compassNeedle"></div>
                <div class="compass-center"></div>
            </div>
            <div id="infoPanel">
                <div id="degrees">0¬∞</div>
                <div id="qiblaLabel">This direction is Qibla</div>
                <div class="info-row">
                    <span class="info-label">Current Location:</span>
                    <span class="info-value" id="currentLocationFallback">--</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Expected Qibla:</span>
                    <span class="info-value" id="expectedQiblaFallback">--</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Current Direction:</span>
                    <span class="info-value" id="currentDirectionFallback">--</span>
                </div>
            </div>
        </div>

        <div id="overlay">
            <div id="qiblaDome">
                <div class="window-frame">
                    <div class="window-panes">
                        <div class="window-pane"></div>
                        <div class="window-pane"></div>
                        <div class="window-pane"></div>
                        <div class="window-pane"></div>
                    </div>
                    <div class="makkah-image"></div>
                    <div class="window-shutters">
                        <div class="window-shutter-left"></div>
                        <div class="window-shutter-right"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="infoPanel">
            <div id="degrees">0¬∞</div>
            <div id="qiblaLabel">This direction is Qibla</div>
            <div class="info-row">
                <span class="info-label">Current Location:</span>
                <span class="info-value" id="currentLocation">--</span>
            </div>
            <div class="info-row">
                <span class="info-label">Expected Qibla:</span>
                <span class="info-value" id="expectedQibla">--</span>
            </div>
            <div class="info-row">
                <span class="info-label">Current Direction:</span>
                <span class="info-value" id="currentDirection">--</span>
            </div>
        </div>

        <div id="status" class="loading">Initializing...</div>

        <div id="disclaimer">
            Compass accuracy depends on device calibration. For best results, calibrate your device's compass by moving it in a figure-8 pattern.
        </div>

        <div id="instructions">
            <h2>Qibla Finder <span style="font-size: 0.7em; color: rgba(255, 255, 255, 0.6); font-weight: normal;">v1.8.0</span></h2>
            <p>Choose your location:</p>
            
            <div class="location-option">
                <div class="location-option-title">üìç Search for a City</div>
                <div id="locationSearch">
                    <input type="text" id="locationInput" placeholder="Enter city name (e.g., London, New York, Dubai)">
                    <div id="searchResults"></div>
                </div>
            </div>

            <div class="location-option">
                <div class="location-option-title">üìç Use Current Location (GPS)</div>
                <button id="useGPSBtn">Use My Location</button>
            </div>

            <p style="margin-top: 20px; font-size: 14px; color: rgba(255, 255, 255, 0.7);">
                This app also needs access to:<br>
                üß≠ Device orientation (compass)<br>
                üì∑ Camera (for AR view)
            </p>
            <p style="margin-top: 15px; font-size: 13px; color: rgba(255, 255, 255, 0.6);">
                Point your phone forward and turn to face the green dome to find Qibla.
            </p>
        </div>

        <div id="error"></div>
    </div>

    <script>
        // Kaaba coordinates in Makkah
        const KAABA_LAT = 21.4225;
        const KAABA_LON = 39.8262;

        let userLat = null;
        let userLon = null;
        let deviceHeading = 0;
        let deviceBeta = 0;  // Device tilt (front-back)
        let deviceGamma = 0; // Device tilt (left-right)
        let qiblaBearing = 0;
        let cameraAvailable = false;
        let orientationAvailable = false;
        let locationAvailable = false;

        const video = document.getElementById('video');
        const qiblaDome = document.getElementById('qiblaDome');
        const degreesDisplay = document.getElementById('degrees');
        const statusDisplay = document.getElementById('status');
        const instructions = document.getElementById('instructions');
        const errorDisplay = document.getElementById('error');
        const compassFallback = document.getElementById('compassFallback');
        const compassNeedle = document.getElementById('compassNeedle');
        const startBtn = document.getElementById('startBtn');
        const currentLocationDisplay = document.getElementById('currentLocation');
        const expectedQiblaDisplay = document.getElementById('expectedQibla');
        const currentDirectionDisplay = document.getElementById('currentDirection');
        const currentLocationFallback = document.getElementById('currentLocationFallback');
        const expectedQiblaFallback = document.getElementById('expectedQiblaFallback');
        const currentDirectionFallback = document.getElementById('currentDirectionFallback');
        const locationInput = document.getElementById('locationInput');
        const searchResults = document.getElementById('searchResults');
        const useGPSBtn = document.getElementById('useGPSBtn');
        let selectedLocationName = null;

        // Calculate bearing from user location to Kaaba
        function calculateQiblaBearing(lat1, lon1, lat2, lon2) {
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const lat1Rad = lat1 * Math.PI / 180;
            const lat2Rad = lat2 * Math.PI / 180;

            const y = Math.sin(dLon) * Math.cos(lat2Rad);
            const x = Math.cos(lat1Rad) * Math.sin(lat2Rad) - 
                      Math.sin(lat1Rad) * Math.cos(lat2Rad) * Math.cos(dLon);

            let bearing = Math.atan2(y, x);
            bearing = bearing * 180 / Math.PI;
            bearing = (bearing + 360) % 360;

            return bearing;
        }

        // Format coordinates for display
        function formatCoordinate(coord, isLat) {
            const direction = isLat ? (coord >= 0 ? 'N' : 'S') : (coord >= 0 ? 'E' : 'W');
            return `${Math.abs(coord).toFixed(4)}¬∞ ${direction}`;
        }

        // Update info displays
        function updateInfoDisplays() {
            if (userLat === null || userLon === null) {
                currentLocationDisplay.textContent = '--';
                currentLocationFallback.textContent = '--';
                expectedQiblaDisplay.textContent = '--';
                expectedQiblaFallback.textContent = '--';
                return;
            }

            // Update location display - show city name if available, otherwise coordinates
            let locationText;
            if (selectedLocationName) {
                locationText = `${selectedLocationName} (${formatCoordinate(userLat, true)}, ${formatCoordinate(userLon, false)})`;
            } else {
                locationText = `${formatCoordinate(userLat, true)}, ${formatCoordinate(userLon, false)}`;
            }
            currentLocationDisplay.textContent = locationText;
            currentLocationFallback.textContent = locationText;

            // Update expected Qibla direction
            const expectedQiblaText = `${Math.round(qiblaBearing)}¬∞`;
            expectedQiblaDisplay.textContent = expectedQiblaText;
            expectedQiblaFallback.textContent = expectedQiblaText;
        }

        // Geocode city name to coordinates using OpenStreetMap Nominatim
        async function geocodeCity(cityName) {
            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(cityName)}&limit=5`,
                    {
                        headers: {
                            'User-Agent': 'QiblaFinder/1.0'
                        }
                    }
                );
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Geocoding error:', error);
                showError('Failed to search for location. Please try again.');
                return [];
            }
        }

        // Handle location input
        let searchTimeout;
        locationInput.addEventListener('input', (e) => {
            const query = e.target.value.trim();
            
            clearTimeout(searchTimeout);
            
            if (query.length < 2) {
                searchResults.classList.remove('active');
                return;
            }

            searchTimeout = setTimeout(async () => {
                statusDisplay.textContent = 'Searching for location...';
                statusDisplay.className = 'loading';
                
                const results = await geocodeCity(query);
                
                if (results.length === 0) {
                    searchResults.innerHTML = '<div class="search-result-item" style="color: rgba(255,255,255,0.5);">No results found</div>';
                    searchResults.classList.add('active');
                    statusDisplay.textContent = '';
                    statusDisplay.className = '';
                    return;
                }

                searchResults.innerHTML = results.map(result => {
                    const name = result.display_name.split(',')[0];
                    const details = result.display_name.split(',').slice(1, 3).join(',').trim();
                    return `
                        <div class="search-result-item" data-lat="${result.lat}" data-lon="${result.lon}" data-name="${result.display_name}">
                            <div class="search-result-name">${name}</div>
                            <div class="search-result-details">${details}</div>
                        </div>
                    `;
                }).join('');

                // Add click handlers
                searchResults.querySelectorAll('.search-result-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const lat = parseFloat(item.dataset.lat);
                        const lon = parseFloat(item.dataset.lon);
                        const name = item.dataset.name;
                        
                        userLat = lat;
                        userLon = lon;
                        selectedLocationName = name.split(',')[0];
                        locationAvailable = true;
                        qiblaBearing = calculateQiblaBearing(userLat, userLon, KAABA_LAT, KAABA_LON);
                        
                        locationInput.value = selectedLocationName;
                        searchResults.classList.remove('active');
                        
                        statusDisplay.textContent = `Location set: ${selectedLocationName} ‚úì`;
                        statusDisplay.className = '';
                        
                        // Hide instructions
                        instructions.classList.add('hidden');
                        
                        updateInfoDisplays();
                        updateArrow();
                        
                        // Start camera and orientation
                        requestCamera();
                        requestOrientation();
                    });
                });

                searchResults.classList.add('active');
                statusDisplay.textContent = '';
                statusDisplay.className = '';
            }, 500);
        });

        // Close search results when clicking outside
        document.addEventListener('click', (e) => {
            if (!locationInput.contains(e.target) && !searchResults.contains(e.target)) {
                searchResults.classList.remove('active');
            }
        });

        // Update AR window position
        function updateArrow() {
            if (userLat === null || userLon === null) return;

            // Calculate angle difference between Qibla direction and device heading
            // Device heading is clockwise from north (0-360)
            // Qibla bearing is also clockwise from north (0-360)
            const angle = qiblaBearing - deviceHeading;
            
            // Normalize angle to -180 to 180
            let normalizedAngle = angle;
            while (normalizedAngle > 180) normalizedAngle -= 360;
            while (normalizedAngle < -180) normalizedAngle += 360;

            // AR positioning: Place window in 3D space at fixed distance in Qibla direction
            // Convert angle to radians for calculations
            const angleRad = (normalizedAngle * Math.PI) / 180;
            const betaRad = (deviceBeta * Math.PI) / 180;
            const gammaRad = (deviceGamma * Math.PI) / 180;
            
            // Fixed distance in 3D space (in pixels, adjusted for perspective)
            const distance = 1500; // Distance from camera
            
            // Calculate 3D position based on Qibla direction
            // X: horizontal position based on angle difference
            // Y: vertical position based on device tilt
            // Z: depth (distance from camera)
            const x = Math.sin(angleRad) * distance;
            const y = -Math.sin(betaRad) * distance * 0.5; // Adjust for device tilt
            const z = -Math.cos(angleRad) * distance;
            
            // Convert 3D position to screen coordinates
            // Use perspective projection
            const fov = 1000; // Field of view
            const scale = fov / (fov + z);
            
            // Calculate screen position
            const screenX = x * scale;
            const screenY = y * scale;
            
            // Apply 3D transform to position window in AR space
            // Rotate window to face camera
            const rotateY = normalizedAngle;
            const rotateX = -deviceBeta * 0.3; // Slight tilt based on device orientation
            
            qiblaDome.style.transform = `
                translate(calc(-50% + ${screenX}px), calc(-50% + ${screenY}px))
                translateZ(${z}px)
                rotateY(${rotateY}deg)
                rotateX(${rotateX}deg)
                scale(${scale})
            `;
            
            // Update compass needle for fallback view
            compassNeedle.style.transform = `translate(-50%, -100%) rotate(${normalizedAngle}deg)`;

            // Update degrees display
            const degrees = Math.round(qiblaBearing);
            degreesDisplay.textContent = `${degrees}¬∞`;

            // Update info displays
            updateInfoDisplays();

            // Update current direction
            const currentDirectionText = `${Math.round(deviceHeading)}¬∞`;
            currentDirectionDisplay.textContent = currentDirectionText;
            currentDirectionFallback.textContent = currentDirectionText;

            // Update status
            const withinRange = Math.abs(normalizedAngle) <= 25;
            if (withinRange) {
                if (Math.abs(normalizedAngle) < 5) {
                    statusDisplay.textContent = '‚úì You are facing Qibla!';
                    statusDisplay.style.color = '#00ff88';
                } else {
                    statusDisplay.textContent = '‚úì You are close to Qibla - look at the window';
                    statusDisplay.style.color = '#00ff88';
                }
            } else {
                // Calculate how many degrees off
                const degreesOff = Math.round(Math.abs(normalizedAngle));
                statusDisplay.textContent = `Turn ${degreesOff}¬∞ ${normalizedAngle > 0 ? 'right' : 'left'} to face Qibla - window shows the direction`;
                statusDisplay.style.color = '#fff';
            }
        }

        // Request GPS location
        function requestGPSLocation() {
            if (!navigator.geolocation) {
                showError('Geolocation is not supported by your browser.');
                return;
            }

            statusDisplay.textContent = 'Requesting location...';
            statusDisplay.className = 'loading';

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    userLat = position.coords.latitude;
                    userLon = position.coords.longitude;
                    selectedLocationName = null; // Clear city name when using GPS
                    locationAvailable = true;
                    qiblaBearing = calculateQiblaBearing(userLat, userLon, KAABA_LAT, KAABA_LON);
                    statusDisplay.textContent = 'Location detected ‚úì';
                    statusDisplay.className = '';
                    // Update displays even if device heading not yet available
                    updateInfoDisplays();
                    updateArrow();
                    
                    // Hide instructions and start camera/orientation
                    instructions.classList.add('hidden');
                    requestCamera();
                    requestOrientation();
                },
                (error) => {
                    let errorMsg = 'Location access denied. ';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMsg += 'Please enable location access in your browser settings.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMsg += 'Location information unavailable.';
                            break;
                        case error.TIMEOUT:
                            errorMsg += 'Location request timed out.';
                            break;
                        default:
                            errorMsg += 'An unknown error occurred.';
                            break;
                    }
                    showError(errorMsg);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        }

        // Request camera access
        function requestCamera() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                // Camera not available, use compass fallback
                cameraAvailable = false;
                video.style.display = 'none';
                compassFallback.classList.add('active');
                return;
            }

            statusDisplay.textContent = 'Requesting camera access...';
            statusDisplay.className = 'loading';

            navigator.mediaDevices.getUserMedia({ 
                video: { 
                    facingMode: 'environment',
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                } 
            })
            .then((stream) => {
                video.srcObject = stream;
                cameraAvailable = true;
                video.style.display = 'block';
                compassFallback.classList.remove('active');
                statusDisplay.textContent = 'Camera active ‚úì';
                statusDisplay.className = '';
            })
            .catch((error) => {
                console.log('Camera error:', error);
                cameraAvailable = false;
                video.style.display = 'none';
                compassFallback.classList.add('active');
                statusDisplay.textContent = 'Using compass view (camera unavailable)';
                statusDisplay.className = '';
            });
        }

        // Request device orientation
        let orientationHandler = null;
        
        function requestOrientation() {
            // Remove existing listener if any
            if (orientationHandler) {
                window.removeEventListener('deviceorientation', orientationHandler);
            }
            
            orientationHandler = handleOrientation;
            
            if (typeof DeviceOrientationEvent === 'undefined') {
                showError('Device orientation is not supported by your browser.');
                return;
            }
            
            // Check if we need to request permission (iOS 13+)
            if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                // iOS 13+ permission request
                statusDisplay.textContent = 'Requesting compass access...';
                statusDisplay.className = 'loading';

                DeviceOrientationEvent.requestPermission()
                    .then(response => {
                        if (response === 'granted') {
                            window.addEventListener('deviceorientation', orientationHandler);
                            orientationAvailable = true;
                            statusDisplay.textContent = 'Compass active ‚úì';
                            statusDisplay.className = '';
                        } else {
                            showError('Compass access denied. Please enable device orientation in your browser settings.');
                        }
                    })
                    .catch((error) => {
                        console.log('Orientation error:', error);
                        showError('Could not access device orientation.');
                    });
            } else {
                // Android/Chrome - add listener directly
                window.addEventListener('deviceorientation', orientationHandler);
                orientationAvailable = true;
                statusDisplay.textContent = 'Compass active ‚úì';
                statusDisplay.className = '';
            }
        }

        // Handle device orientation
        function handleOrientation(event) {
            let heading = null;
            
            // iOS Safari - use webkitCompassHeading (most reliable, already calibrated)
            if (event.webkitCompassHeading !== undefined && event.webkitCompassHeading !== null) {
                heading = event.webkitCompassHeading;
            }
            // Android/Chrome - use alpha for compass heading
            else if (event.alpha !== null && event.alpha !== undefined) {
                // Check if we have absolute orientation (relative to Earth's coordinate system)
                if (event.absolute === true) {
                    // alpha is the compass heading (0-360, clockwise from north)
                    heading = event.alpha;
                } else {
                    // Relative orientation - alpha is relative to device's initial orientation
                    // On many Android devices, even without absolute=true, alpha can still be used
                    // but we need to account for device orientation
                    // For portrait mode, alpha should work directly
                    // For landscape, we might need adjustment
                    const screenOrientation = window.orientation || 0;
                    
                    if (screenOrientation === 0 || screenOrientation === 180) {
                        // Portrait mode - alpha should be correct
                        heading = event.alpha;
                    } else {
                        // Landscape mode - may need adjustment
                        // Try using alpha directly first
                        heading = event.alpha;
                    }
                }
            }
            
            // Capture device tilt for AR positioning
            if (event.beta !== null && event.beta !== undefined) {
                deviceBeta = event.beta; // Front-back tilt (-180 to 180)
            }
            if (event.gamma !== null && event.gamma !== undefined) {
                deviceGamma = event.gamma; // Left-right tilt (-90 to 90)
            }
            
            if (heading !== null && !isNaN(heading) && heading >= 0 && heading <= 360) {
                deviceHeading = heading;
                updateArrow();
            } else if (event.beta !== null || event.gamma !== null) {
                // Update even if heading not available, for tilt adjustments
                updateArrow();
            }
        }

        // Show error message
        function showError(message) {
            errorDisplay.textContent = message;
            errorDisplay.classList.add('active');
            statusDisplay.textContent = 'Error occurred';
            statusDisplay.className = '';
            
            setTimeout(() => {
                errorDisplay.classList.remove('active');
            }, 5000);
        }

        // Initialize GPS button
        useGPSBtn.addEventListener('click', () => {
            requestGPSLocation();
        });

        // Handle dome click - toggle doors open/close
        qiblaDome.addEventListener('click', () => {
            // Toggle opened state
            if (qiblaDome.classList.contains('opened')) {
                qiblaDome.classList.remove('opened');
            } else {
                qiblaDome.classList.add('opened');
            }
        });

        // Handle page visibility (pause/resume)
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                // Page is hidden, could pause updates
            } else {
                // Page is visible, refresh location if needed (only if using GPS)
                if ((userLat === null || userLon === null) && !selectedLocationName) {
                    // Only refresh if not using a manually selected city
                }
            }
        });
    </script>
</body>
</html>
